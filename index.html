<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>IslamNet | Digital Islamic Suite</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;800&family=Amiri&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --pure-black: #000000;
            --glass-bg: rgba(255, 255, 255, 0.04);
            --glass-border: rgba(255, 255, 255, 0.12);
            --text-main: #ffffff;
            --input-bg: #000000;
        }

        body.light-mode {
            --pure-black: #f5f5dc; 
            --glass-bg: rgba(0, 128, 128, 0.1); 
            --glass-border: rgba(0, 128, 128, 0.3);
            --text-main: #004d4d;
            --input-bg: #ffffff;
        }

        * { box-sizing: border-box; transition: all 0.3s ease; }
        body, html { margin: 0; padding: 0; background: var(--pure-black); color: var(--text-main); font-family: 'Montserrat', sans-serif; height: 100vh; overflow: hidden; }

        #loader { position: fixed; inset: 0; background: var(--pure-black); z-index: 9999; display: flex; align-items: center; justify-content: center; font-weight: 800; color: var(--text-main); }

        #loader {
            transition: opacity 0.8s ease;
        }

        body.light-mode .stars-container { display: none; }
        
        .app-shell { height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 10px 0; }
        .header-row { display: flex; justify-content: space-between; width: 94%; max-width: 1500px; align-items: center; margin-bottom: 10px; }
        .brand-header { font-weight: 800; font-size: 1.5rem; letter-spacing: -1px; }

        .mode-toggle { cursor: pointer; padding: 8px 15px; border: 1px solid var(--glass-border); border-radius: 20px; font-size: 0.7rem; font-weight: 700; background: var(--glass-bg); color: var(--text-main); }

        .content-window { width: 96%; max-width: 1500px; height: 76vh; background: var(--glass-bg); backdrop-filter: blur(45px); -webkit-backdrop-filter: blur(45px); border: 1px solid var(--glass-border); border-radius: 25px; overflow: hidden; position: relative; }
        
        .view { display: none; height: 100%; width: 100%; padding: 25px; overflow-y: auto; padding-bottom: 140px; }
        .view.active { display: block; }

        /* PRAYER GRID */
        .prayer-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .p-card { background: var(--glass-bg); padding: 20px; border-radius: 20px; text-align: center; border: 1px solid var(--glass-border); }
        .p-card b { display: block; font-size: 1.2rem; margin-top: 5px; }

        #nafl-info-box { display: none; background: var(--glass-bg); padding: 15px; border-radius: 15px; border: 1px solid var(--glass-border); margin-bottom: 20px; font-size: 0.85rem; line-height: 1.4; }

        /* CALENDAR */
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .cal-day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 12px; font-size: 0.8rem; position: relative; }
        .cal-day.today { background: var(--text-main); color: var(--pure-black); font-weight: 800; }
        .holiday-label { font-size: 0.5rem; text-align: center; margin-top: 2px; opacity: 0.8; }

        /* CHAT */
        #chat-ui { display: flex; flex-direction: column; gap: 15px; }
        .msg { padding: 18px; border-radius: 15px; max-width: 85%; border: 1px solid var(--glass-border); background: var(--glass-bg); }
        .msg.user { align-self: flex-end; background: rgba(255,255,255,0.05); }

        /* NAV WRAPPER FIX */
        .nav-wrapper { position: fixed; bottom: 25px; left: 0; width: 100%; display: flex; justify-content: center; z-index: 1000; }
        .tab-bar { background: rgba(255, 255, 255, 0.08); backdrop-filter: blur(25px); border: 1px solid var(--glass-border); border-radius: 50px; padding: 5px; display: flex; gap: 4px; max-width: 94%; overflow-x: auto; scrollbar-width: none; }
        .tab { padding: 12px 18px; border-radius: 40px; cursor: pointer; font-size: 0.6rem; font-weight: 700; color: var(--text-main); opacity: 0.5; text-transform: uppercase; white-space: nowrap; }
        .tab.active { background: var(--text-main); color: var(--pure-black); opacity: 1; }

        iframe { width: 100%; height: 100%; border: none; }
        .input-area { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 700px; }
        .input-area input { width: 100%; padding: 16px 25px; border-radius: 40px; background: var(--input-bg); color: var(--text-main); border: 1px solid var(--glass-border); outline: none; }
        
        .arabic { font-family: 'Amiri', serif; font-size: 2rem; margin-bottom: 10px; line-height: 1.6; }
    </style>
</head>
<body onload="hideLoader()">
    <div id="loader">ISLAMNET</div>
    <div class="stars-container" id="stars"></div>

    <div class="app-shell">
        <div class="header-row">
            <div class="brand-header">ISLAMNET</div>
            <button class="mode-toggle" onclick="toggleMode()">üåì THEME</button>
        </div>
        
        <div class="content-window">
            <section id="chat-view" class="view active">
                <div id="chat-ui"><div class="msg ai">Bismillah.</div></div>
                <div id="typing" style="display:none; padding:10px; font-size:0.8rem; opacity:0.6;">Thinking...</div>
                <div class="input-area"><input type="text" id="userInput" placeholder="Ask..." onkeypress="if(event.key==='Enter') startChat()"></div>
            </section>

            <section id="prayer-view" class="view">
                <div style="display:flex; gap:10px; justify-content:center; margin-bottom:20px; flex-wrap:wrap;">
                    <input type="text" id="cityInput" placeholder="Enter City..." style="background:var(--input-bg); color:var(--text-main); border:1px solid var(--glass-border); padding:10px; border-radius:10px;">
                    <select id="madhabSelect" style="background:var(--input-bg); color:var(--text-main); border:1px solid var(--glass-border); padding:10px; border-radius:10px;">
                        <option value="0">Maliki/Shafi/Hanbali</option>
                        <option value="1">Hanafi (Asr Later)</option>
                    </select>
                    <button onclick="getPrayers()" style="background:var(--text-main); color:var(--pure-black); border:none; padding:10px 20px; border-radius:10px; font-weight:700;">FIND</button>
                </div>
                <div id="prayer-grid" class="prayer-grid"></div>
                
                <h3 style="font-size:0.7rem; letter-spacing:2px; margin-top:30px;">NAFL PRAYERS <span onclick="toggleNaflInfo()" style="cursor:pointer; opacity:0.5; text-decoration: underline;">[INFO]</span></h3>
                <div id="nafl-info-box">
                    <b>Dhuha:</b> Prayed ~20 mins after sunrise.<br>
                    <b>Tahajjud:</b> Prayed in the last third of the night.<br>
                    <b>Tahiyat al-Wudu:</b> Voluntary prayer after performing wudu.<br>
                    <b>Awabeen:</b> Prayed after Maghrib (No Sahih Hadith, but permissible).
                </div>
                <div id="nafl-grid" class="prayer-grid"></div>
            </section>

            <section id="cal-view" class="view">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <button onclick="changeMonth(-1)" style="background:none; border:none; color:inherit; font-size:1.5rem;">‚Üê</button>
                    <div style="text-align:center;">
                        <h2 id="hijri-month-display" style="margin:0;"></h2>
                        <p id="gregorian-sub" style="margin:0; font-size:0.8rem; opacity:0.6;"></p>
                    </div>
                    <button onclick="changeMonth(1)" style="background:none; border:none; color:inherit; font-size:1.5rem;">‚Üí</button>
                </div>
                <div class="cal-grid" id="calendar-grid"></div>
            </section>

            <section id="quote-view" class="view">
                <div id="q-container" style="text-align:center; padding-top:40px;"></div>
            </section>

            <section id="quran-view" class="view" style="padding:0;"><iframe src="https://quran.com"></iframe></section>
            <section id="hadith-view" class="view" style="padding:0;"><iframe src="https://sunnah.com"></iframe></section>
            <section id="rec-view" class="view"><h2 style="text-align:center; margin-top:100px;">AUDIO RECITATIONS: IN PROGRESS</h2></section>
        </div>
    </div>

    <div class="nav-wrapper">
        <div class="tab-bar">
            <div class="tab active" onclick="switchView('chat-view', this)">Chat</div>
            <div class="tab" onclick="switchView('prayer-view', this)">Prayers</div>
            <div class="tab" onclick="switchView('cal-view', this)">Calendar</div>
            <div class="tab" onclick="switchView('quote-view', this)">Quotes</div>
            <div class="tab" onclick="switchView('quran-view', this)">Quran</div>
            <div class="tab" onclick="switchView('hadith-view', this)">Hadith</div>
            <div class="tab" onclick="switchView('rec-view', this)">Audio</div>
        </div>
    </div>

    <script>
        function hideLoader() { setTimeout(() => document.getElementById('loader').style.display='none', 800); }
        function toggleMode() { document.body.classList.toggle('light-mode'); }
        function toggleNaflInfo() { let b=document.getElementById('nafl-info-box'); b.style.display=(b.style.display==='block')?'none':'block'; }

        // AUTO LOCATION DETECTOR
window.addEventListener('DOMContentLoaded', () => {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(async (position) => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;

            try {
                // Using BigDataCloud's free reverse geocoding API to get city name
                const geoRes = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=en`);
                const geoData = await geoRes.json();
                
                const cityName = geoData.city || geoData.locality || "London";
                document.getElementById('cityInput').value = cityName;
                
                // Automatically fetch prayers once city is found
                getPrayers();
            } catch (err) {
                console.error("Location lookup failed", err);
            }
        }, (error) => {
            console.log("User denied location or error occurred.");
        });
    }
});
        
        // PRAYERS & NAFL
        async function getPrayers() {
            const city = document.getElementById('cityInput').value;
            const school = document.getElementById('madhabSelect').value;
            if(!city) return;
            const res = await fetch(
              `https://api.aladhan.com/v1/timingsByCity?city=${city}&method=2&school=${school}`
            );
            const d = await res.json();
            const t = d.data.timings;
            
            document.getElementById('prayer-grid').innerHTML = ['Fajr','Dhuhr','Asr','Maghrib','Isha'].map(n => 
                `<div class="p-card"><span>${n}</span><b>${t[n]}</b></div>`
            ).join('');
            
            document.getElementById('nafl-grid').innerHTML = `
                <div class="p-card"><span>Dhuha</span><b>${t.Sunrise}</b></div>
                <div class="p-card"><span>Tahajjud</span><b>Last 1/3</b></div>
            `;
        }

        // HIJRI CALENDAR
        let calOffset = 0;
        const holidays = { "1-1": "Hijri New Year", "10-1": "Ashura", "12-3": "Mawlid", "1-9": "Ramadan Start", "1-10": "Eid al-Fitr", "10-12": "Eid al-Adha" };

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid'); grid.innerHTML = '';
            const baseDate = new Date(); baseDate.setMonth(baseDate.getMonth() + calOffset);
            
            const hijriFormatter = new Intl.DateTimeFormat('en-u-ca-islamic-uma', {day:'numeric', month:'numeric', monthName:'long', year:'numeric'});
            const parts = hijriFormatter.formatToParts(baseDate);
            const hMonth = parts.find(p => p.type === 'month').value;
            const hYear = parts.find(p => p.type === 'year').value;
            const hMonthIndex = new Intl.DateTimeFormat('en-u-ca-islamic-uma', { month: 'numeric' })
                .format(baseDate);

            document.getElementById('hijri-month-display').innerText = `${hMonth} ${hYear}`;
            document.getElementById('gregorian-sub').innerText = baseDate.toLocaleString('default', { month: 'long', year: 'numeric' });

            for(let i=1; i<=30; i++) {
                const isToday = (i == new Intl.DateTimeFormat('en-u-ca-islamic-uma', {day:'numeric'}).format(new Date()) && calOffset === 0);
                const holidayKey = `${i}-${hMonthIndex}`;
                const holiday = holidays[holidayKey] ? `<span class="holiday-label">${holidays[holidayKey]}</span>` : '';
                grid.innerHTML += `<div class="cal-day ${isToday?'today':''}">${i}${holiday}</div>`;
            }
        }
        function changeMonth(dir) { calOffset += dir; renderCalendar(); }

        // DAILY QUOTE (24H)
        async function loadDailyQuote() {
            const today = new Date().toDateString();
            if(localStorage.getItem('q_date') !== today) {
                const res = await fetch('https://api.alquran.cloud/v1/ayah/random/editions/quran-uthmani,en.sahih');
                const d = await res.json();
                localStorage.setItem('q_data', JSON.stringify(d.data));
                localStorage.setItem('q_date', today);
            }
            const q = JSON.parse(localStorage.getItem('q_data'));
            document.getElementById('q-container').innerHTML = `<p class="arabic">${q[0].text}</p><p style="opacity:0.8;">${q[1].text}</p>`;
        }

        function switchView(id, el) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            el.classList.add('active');
            if(id === 'cal-view') renderCalendar();
            if(id === 'quote-view') loadDailyQuote();
        }

        async function startChat() {
            const ui = document.getElementById('chat-ui');
            const input = document.getElementById('userInput');
            if(!input.value) return;
            ui.innerHTML += `<div class="msg user">${input.value}</div>`;
            document.getElementById('typing').style.display='block';
            input.value = "";
            // Add fetch logic to /api/ask here
        }

        // STARS INIT
        const sc = document.getElementById('stars');
        for(let i=0; i<80; i++) {
            let s = document.createElement('div'); s.className='star';
            s.style.width=s.style.height=Math.random()*2+'px';
            s.style.left=Math.random()*100+'%'; s.style.top=Math.random()*100+'%';
            s.style.setProperty('--d', (Math.random()*4+2)+'s'); sc.appendChild(s);
        }
    </script>
</body>
</html>
